{% extends "base.html" %}
{% block content %}
<h2>ðŸ“¡ Tightbeam Messages</h2>
<table border="1" cellpadding="8">
  <tr>
    <th>From</th>
    <th>To</th>
    <th>Sent Time (UTC)</th>
    <th>Message</th>
    <th>Status</th>
    <th>Reply</th>
  </tr>
  {% for msg in messages %}
  <tr>
    <td>{{ msg.player_code }}</td>
    <td>{{ msg.target.name }}</td>
    <td>{{ msg.sent_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
    <td>
      <audio controls>
        <source src="{{ url_for('static', filename='audio_messages/' + message.filename) }}" type="audio/webm">
      </audio>
    </td>
    <td>
      {% if msg.response_time %}
        Responded at {{ msg.response_time.strftime('%H:%M:%S') }}
      {% else %}
        <em>No response</em>
      {% endif %}
    </td>
    <td>
      {% if msg.response_path %}
        <audio controls src="{{ url_for('static', filename=msg.response_path) }}"></audio>
      {% elif (msg.sent_time.timestamp() + msg.target.delay_seconds / 2) <= now().timestamp() %}
        <form method="post" action="/control/respond/{{ msg.id }}" enctype="multipart/form-data">
          <input type="file" name="reply_file" accept="audio/*" required>
          <button type="submit">Send Reply</button>
        </form>
      {% else %}
        <small>Reply available in {{ ((msg.sent_time.timestamp() + msg.target.delay_seconds / 2) - now().timestamp())|round }}s</small>
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}
