<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ panel.title }}</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    {% if panel.system %}
        <link rel="stylesheet" href="{{ url_for('static', filename='css/' + panel.system|lower + '.css') }}">
    {% endif %}
</head>
<body>

<div class="panel-container">
    <div class="title-bar">
        <div class="logo">
          <svg viewBox="0 0 100 100" width="40" height="40" xmlns="http://www.w3.org/2000/svg">
            <style>
                .L1 {
                stroke: var(--bg-color);
                stroke-width: 14;
                }
                .L2 {
                stroke: var(--bg-color);
                stroke-width: 6;
                }
            </style>
            <circle cx="50" cy="50" r="40" fill="currentColor" />
            <g transform="rotate(325, 50, 50) translate(-5, -5)">
                <path d="M 0,50 C 35,70, 70,70, 100,50" class="L1" fill="transparent" />
            </g>
            <g transform="rotate(310, 50, 50) translate(10, 10)">
                <path d="M 0,50 C 35,75, 70,75, 100,50" class="L2" fill="transparent" />
            </g>
          </svg>
        </div>

        <div class="title-text">
            <div class="main-title">{{ panel.system }} // {{ panel.location }}{% if player %} // {{ player.name }}{% endif %}</div>
            <div class="subtitle">{{ fictional_time.strftime('%Y-%m-%d') }} {{ fictional_time.strftime('%H:%M:%S') }}</div>
          </div>
    </div>

    <div class="panel-content">
        <div class="main-display"> 
            {% if display %}
                {% include "panels/" + display + ".html" %}
            {% else %} 
                {% include "panels/" + panel.primary_display + ".html" %}
            {% endif %}
        </div>

        <div class="menu">
            <div class="scanner-container">
            <div class="scanner-left">
                <div id="qr-reader"></div>
                <div id="qr-scan-result"></div>
            </div>
            <div class="scanner-right">
                <form id="manual-form">
                <input id="manual-code" type="text" pattern="[A-Za-z0-9]{3}-[A-Za-z0-9]{3}" placeholder="ABC-123" required>
                <button type="submit">Submit Code</button>
                </form>
                <div id="manual-result"></div>
            </div>
            </div>

            {% for key, label in menu_items %}
                <div class="menu-item">
                    <span class="menu-key">{{ key }}</span>
                    <a href="{{ url_for('main.panel_view',
                            panel_code=panel.code,
                            display=(label | replace(' ', '_')))
                        + ('/' + player.code if player else '')
                        + ('/' + interactable.code if interactable else '') }}">
                        {{ label }}
                    </a>
                </div>
            {% endfor %}


        </div>
    </div>
</div>

<script>
  function redirectFromCode(code) {
    const parts = window.location.pathname.split('/').filter(Boolean);
    let [_, currentPanel, currentDisplay, currentPlayer, currentInteractable] = parts;

    if (code.startsWith("T")) {
      currentPanel = code;
    } else if (code.startsWith("E") || code.startsWith("R") || code.startsWith("P")) {
      currentPlayer = code;
    } else {
      currentInteractable = code;
    }

    let path = `/panel/${currentPanel}`;
    if (currentDisplay) path += `/${currentDisplay}`;
    if (currentPlayer) path += `/${currentPlayer}`;
    if (currentInteractable) path += `/${currentInteractable}`;

    // Delay redirect to show scanned result
    setTimeout(() => {
      window.location.href = path;
    }, 1500);
  }

  const qrReader = new Html5Qrcode("qr-reader");

  qrReader.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    (decodedText, decodedResult) => {
      const code = decodedText.trim().toUpperCase();
      document.getElementById('qr-scan-result').innerText = `Scanned: ${code}`;

      qrReader.stop().then(() => {
        redirectFromCode(code);
      }).catch(err => console.error("Failed to stop QR reader", err));
    },
    (errorMessage) => {
      // ignore errors
    }
  );

  document.getElementById('manual-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const code = document.getElementById('manual-code').value.trim().toUpperCase();
    const isValid = /^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(code);

    if (isValid) {
      document.getElementById('manual-result').innerText = `Entered: ${code}`;
      redirectFromCode(code);
    } else {
      document.getElementById('manual-result').innerText = "Invalid code format. Use ABC-123.";
    }
  });
</script>


</body>
</html>
