<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ panel.title }}</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        #qr-reader {
            width: 250px;
            margin-top: 1rem;
        }
    </style>
</head>
<body>

<div class="panel-container">
    <div class="title-bar">
        {{ panel.system }} // {{ panel.location }}{% if player %} // {{ player.name }}{% endif %}
    </div>

    <div class="main-display"> 
        <hr>

        <h3>Manual Code Entry</h3>
        <form id="manual-form">
            <input id="manual-code" type="text" pattern="[A-Za-z0-9]{3}-[A-Za-z0-9]{3}" placeholder="ABC-123" required>
            <button type="submit">Submit Code</button>
        </form>
        <div id="manual-result" style="margin-top: 1rem; font-weight: bold;"></div>

        <div id="qr-reader"></div>
        <div id="qr-scan-result" style="margin-top: 0.5rem; font-weight: bold; color: green;"></div>


        {% if display %}
            {% include "panels/" + display + ".html" %}
        {% else %}
            {% include panel.primary_display %}
        {% endif %}
    </div>

    <div class="menu">
        <h3>Menu</h3>
        {% for key, label in menu_items %}
            <div class="menu-item">
                <span class="menu-key">{{ key }}</span>
                <a href="{{ url_for('main.panel_view',
                        panel_code=panel.code,
                        display=(label | replace(' ', '_')))
                    + ('/' + player.code if player else '')
                    + ('/' + interactable.code if interactable else '') }}">
                    {{ label }}
                </a>
            </div>
        {% endfor %}

        {% if player_menu %}
            <hr>
            <h4>Player Options</h4>
            {% for key, label in player_menu.items() %}
                <div class="menu-item"><span class="menu-key">{{ key }}</span>{{ label }}</div>
            {% endfor %}
        {% endif %}
    </div>
</div>

<script>
  function redirectFromCode(code) {
    const parts = window.location.pathname.split('/').filter(Boolean);
    let [_, currentPanel, currentDisplay, currentPlayer, currentInteractable] = parts;

    if (code.startsWith("T")) {
      currentPanel = code;
    } else if (code.startsWith("E") || code.startsWith("R") || code.startsWith("P")) {
      currentPlayer = code;
    } else {
      currentInteractable = code;
    }

    let path = `/panel/${currentPanel}`;
    if (currentDisplay) path += `/${currentDisplay}`;
    if (currentPlayer) path += `/${currentPlayer}`;
    if (currentInteractable) path += `/${currentInteractable}`;

    // Delay redirect to show scanned result
    setTimeout(() => {
      window.location.href = path;
    }, 1500);
  }

  const qrReader = new Html5Qrcode("qr-reader");

  qrReader.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 200 },
    (decodedText, decodedResult) => {
      const code = decodedText.trim().toUpperCase();
      document.getElementById('qr-scan-result').innerText = `Scanned: ${code}`;

      qrReader.stop().then(() => {
        redirectFromCode(code);
      }).catch(err => console.error("Failed to stop QR reader", err));
    },
    (errorMessage) => {
      // ignore errors
    }
  );

  document.getElementById('manual-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const code = document.getElementById('manual-code').value.trim().toUpperCase();
    const isValid = /^[A-Z0-9]{3}-[A-Z0-9]{3}$/.test(code);

    if (isValid) {
      document.getElementById('manual-result').innerText = `Entered: ${code}`;
      redirectFromCode(code);
    } else {
      document.getElementById('manual-result').innerText = "Invalid code format. Use ABC-123.";
    }
  });
</script>


</body>
</html>
