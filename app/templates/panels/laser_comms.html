<div class="panel-section">
  <h3>Long-Distance Tightbeam</h3>
  <p>Laser communication to distant faction relays. Subject to light-speed delay.</p>
  {% if player %}
    <form method="POST">
      <input type="hidden" name="form_type" value="send_laser">
      <label for="target_name">Target:</label>
      <select name="target_name" required>
        {% for target in message_targets %}
          <option value="{{ target.name }}">{{ target.name }} ({{ target.distance_in_light_minutes }} min)</option>
        {% endfor %}
      </select>
      <button type="submit">Send Laser Message</button>
    </form>
{% endif %}



<form method="POST" enctype="multipart/form-data">
  <input type="hidden" name="form_type" value="send_laser">
  <select name="target_name">
    {% for target in message_targets %}
      <option value="{{ target.name }}">{{ target.name }}</option>
    {% endfor %}
  </select>

  <div id="recorder">
    <button type="button" id="startBtn">Start Recording</button>
    <button type="button" id="stopBtn" disabled>Stop</button>
    <audio id="audioPlayback" controls></audio>
    <input type="hidden" name="audio_data" id="audioData">
  </div>

  <button type="submit">Send</button>
</form>

<script>
let mediaRecorder;
let chunks = [];
let maxDuration = 30 * 1000;

document.getElementById("startBtn").onclick = async function() {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mediaRecorder = new MediaRecorder(stream);

  chunks = [];
  mediaRecorder.ondataavailable = e => chunks.push(e.data);
  mediaRecorder.onstop = () => {
    const blob = new Blob(chunks, { type: "audio/webm" });
    const audioURL = URL.createObjectURL(blob);
    document.getElementById("audioPlayback").src = audioURL;

    blobToBase64(blob).then(base64 => {
      document.getElementById("audioData").value = base64;
    });
  };

  mediaRecorder.start();
  document.getElementById("stopBtn").disabled = false;
  document.getElementById("startBtn").disabled = true;

  setTimeout(() => {
    if (mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      document.getElementById("stopBtn").disabled = true;
    }
  }, maxDuration);
};

document.getElementById("stopBtn").onclick = () => {
  if (mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
    document.getElementById("stopBtn").disabled = true;
  }
};

function blobToBase64(blob) {
  return new Promise((resolve, _) => {
    const reader = new FileReader();
    reader.onloadend = () => resolve(reader.result.split(',')[1]);
    reader.readAsDataURL(blob);
  });
}
</script>




</div>
